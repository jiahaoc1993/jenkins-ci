pipeline{
    agent any
    stages{
        stage("Build"){
            steps{
                git "https://github.com/jiahaoc1993/jenkins-ci"
            }
        }
        
        stage("Run Playbook") {
            parameters{
                string(name: 'fate_version', defaultValue: 'latest', description: 'Docker image tag for FATE')
                string(name: 'fate_serving_version', defaultValue: 'latest', description: 'Docker image tag for FATE Serving')
                string(name: 'kubefate_version', defaultValue: 'latest', description: 'Docker image tag for KubeFATE')
            }
            steps{
                withCredentials([file(credentialsId: 'ansible-inventory', variable: 'FILE')]){
                    ansiblePlaybook colorized: false, 
                    credentialsId: 'ssh-ansible',
                    installation: 'ansible',
                    inventory: '$FILE',
                    playbook: 'ansible/site.yml',
                    disableHostKeyChecking: true,
                    extraVars: [
                        fate_version: ${fate_version},
                        fate_serving_version: ${fate_serving_version},
                        kubefate_version: ${kubefate_version}]
                }
            }
        }
    }
}